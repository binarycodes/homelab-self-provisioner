global
    log stdout format raw local0
    maxconn 50000

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client  60s
    timeout server  60s

resolvers host_dns
    nameserver dns1 127.0.0.53:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry   1s
    hold valid      30s

frontend https_in
    bind :443
    mode tcp

    # inspect tls clienthello to read sni
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.ssl_hello_type 1 }

    acl mgmt_host req.ssl_sni -i proxmox.cloudyhome.net
    acl mgmt_host req.ssl_sni -i s3.cloudyhome.net
    acl mgmt_host req.ssl_sni -i s3-api.cloudyhome.net
    acl mgmt_host req.ssl_sni -i nas.cloudyhome.net
    acl mgmt_host req.ssl_sni -i gateway.cloudyhome.net
    acl mgmt_host req.ssl_sni -i sw1.cloudyhome.net

    acl lab_host req.ssl_sni -i immich.cloudyhome.net
    acl lab_host req.ssl_sni -i immich-frame.cloudyhome.net

    # route by sni (examples)
    use_backend mgmt_caddy if mgmt_host
    use_backend lab_caddy  if lab_host

    # fail closed for unknown sni
    default_backend reject_backend

backend mgmt_caddy
    mode tcp
    server caddy_mgmt bootstrap.ip.cloudyhome.net:443 check resolvers host_dns resolve-prefer ipv4

backend lab_caddy
    mode tcp
    server caddy_lab media.ip.cloudyhome.net:443 check resolvers host_dns resolve-prefer ipv4

backend reject_backend
    mode tcp
    tcp-request content reject
